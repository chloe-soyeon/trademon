<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.trademon.mapper.ITradeAssetMapper">

    <!-- ðŸ”¹ ê±°ëž˜ ì €ìž¥ -->
    <insert id="insertTradeAsset" parameterType="kr.trademon.dto.TradeAssetDTO">
        INSERT INTO TRADE_ASSET (
            TRADE_ID, USER_EMAIL, ASSET_TYPE, ASSET_CODE, ASSET_NAME,
            TRADE_TYPE, QUNTITY, PRICE, TRADE_TIME
        ) VALUES (
                     #{tradeId}, #{userEmail}, #{assetType}, #{assetCode}, #{assetName},
                     #{tradeType}, #{quntity}, #{price}, #{tradeTime}
                 )
    </insert>

    <!-- ðŸ”¹ íŠ¹ì • ì‹œì ê¹Œì§€ì˜ ìˆ˜ëŸ‰ í•©ê³„ (ë°±í…ŒìŠ¤íŠ¸ìš©) -->
    <select id="sumQuantityUntil" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = #{tradeType}
          AND TRADE_TIME &lt;= #{untilTime}
    </select>

    <!-- ðŸ”¹ ì „ì²´ ë§¤ìˆ˜ ê¸ˆì•¡ -->
    <select id="sumTotalBuyAmount" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY * PRICE), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND TRADE_TYPE = 'BUY'
    </select>

    <!-- ðŸ”¹ ì „ì²´ ë§¤ë„ ê¸ˆì•¡ -->
    <select id="sumTotalSellAmount" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY * PRICE), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND TRADE_TYPE = 'SELL'
    </select>

    <!-- ðŸ”¹ í˜„ìž¬ ë³´ìœ  ì¢…ëª© (ìž”ê³  > 0) -->
    <select id="getCurrentHoldings" resultType="kr.trademon.dto.TradeAssetDTO">
        SELECT
            ASSET_TYPE,
            ASSET_CODE,
            ASSET_NAME,
            SUM(CASE WHEN TRADE_TYPE = 'BUY' THEN QUNTITY ELSE -QUNTITY END) AS QUNTITY
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
        GROUP BY ASSET_TYPE, ASSET_CODE, ASSET_NAME
        HAVING QUNTITY > 0
    </select>

    <!-- ðŸ”¹ íŠ¹ì • ì¢…ëª©ì˜ ë§¤ìˆ˜ ê¸ˆì•¡ í•©ê³„ -->
    <select id="sumBuyAmountForAsset" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY * PRICE), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = 'BUY'
          AND QUNTITY > 0
    </select>

    <!-- ðŸ”¹ ì „ì²´ ì‹¤í˜„ ì†ìµ (ë§¤ë„ ìžì‚° ê¸°ì¤€ ì†ìµ í•©ì‚°) -->
    <select id="sumRealizedProfit" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(
                              CASE WHEN TRADE_TYPE = 'SELL' THEN
                                       (PRICE - (
                                           SELECT AVG(PRICE)
                                           FROM TRADE_ASSET b
                                           WHERE b.USER_EMAIL = a.USER_EMAIL
                                             AND b.ASSET_CODE = a.ASSET_CODE
                                             AND b.TRADE_TYPE = 'BUY'
                                       )) * QUNTITY
                                   ELSE 0 END
                      ), 0)
        FROM TRADE_ASSET a
        WHERE USER_EMAIL = #{userEmail}
    </select>

    <!-- ðŸ”¹ ì‚¬ìš©ìž ê±°ëž˜ ì „ì²´ ì‚­ì œ (ìžì‚° ì´ˆê¸°í™”ìš©) -->
    <delete id="deleteAllByUserEmail">
        DELETE FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
    </delete>

    <select id="getAllTradesByUser" resultType="kr.trademon.dto.TradeAssetDTO">
        SELECT *
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
        ORDER BY TRADE_TIME ASC
    </select>

    <!-- ðŸ”¹ ë‚ ì§œë³„ ìžì‚° ë³€í™” ì¶”ì´ -->
    <select id="getDailyAssetSummary" resultType="map">
        SELECT
            DATE(TRADE_TIME) AS tradeDate,
            SUM(CASE WHEN TRADE_TYPE = 'BUY' THEN -QUNTITY * PRICE
            WHEN TRADE_TYPE = 'SELL' THEN QUNTITY * PRICE
            ELSE 0 END) AS amountChange
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
        GROUP BY DATE(TRADE_TIME)
        ORDER BY tradeDate ASC
    </select>

    <select id="getTradeHistory" parameterType="string" resultType="kr.trademon.dto.TradeAssetDTO">
        SELECT *
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
        ORDER BY TRADE_TIME DESC
    </select>

    <!-- ðŸ”¹ ê±°ëž˜ ë‚´ì—­ (ë§¤ìˆ˜/ë§¤ë„ íƒ€ìž… í•„í„°ë§) -->
    <select id="getTradeHistoryByType" resultType="kr.trademon.dto.TradeAssetDTO">
        SELECT *
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND TRADE_TYPE = #{tradeType}
        ORDER BY TRADE_TIME DESC
    </select>


    <select id="sumQuantityForAsset" resultType="BigDecimal">
        SELECT SUM(QUNTITY)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = #{tradeType}
    </select>
    <!-- ðŸ”¹ ì‹¤ë³´ìœ  ê¸°ì¤€ ë§¤ìž…ê¸ˆì•¡ ê³„ì‚° (ë§¤ë„ ìˆ˜ëŸ‰ì„ ì œì™¸í•œ ë§¤ìˆ˜ ë‚´ì—­ì—ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ëˆ„ì ) -->
    <select id="getEffectiveBuyAmount" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY * PRICE), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = 'BUY'
    </select>


    <!-- getAllBuyTradesForAsset -->
    <select id="getAllBuyTradesForAsset" resultType="kr.trademon.dto.TradeAssetDTO">
        SELECT QUNTITY, PRICE, TRADE_TIME
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = 'BUY'
        ORDER BY TRADE_TIME ASC
    </select>
    <!-- getTotalSellQuantity -->
    <select id="getTotalSellQuantity" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(QUNTITY), 0)
        FROM TRADE_ASSET
        WHERE USER_EMAIL = #{userEmail}
          AND ASSET_CODE = #{assetCode}
          AND TRADE_TYPE = 'SELL'
    </select>



</mapper>
