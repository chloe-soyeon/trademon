<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>TradeMon | ì•”í˜¸í™”í</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/styles.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body { background: #f9fbfd; }
        .container { padding-top: 40px; }
        .card {
            background: #fff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .btn-danger { background-color: #f44336; border-color: #f44336; }
        .btn-primary, .btn-dark { background-color: #1c2e61; border-color: #1c2e61; }
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        .search-container input {
            flex-grow: 1;
        }
        ul.ui-autocomplete {
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
</head>
<body>
<div class="container">
    <div class="card p-4">
        <h2 class="mb-3">ğŸ“ˆ ì•”í˜¸í™”í ì°¨íŠ¸</h2>
        <div class="search-container">
            <input type="text" class="form-control" id="searchInput" placeholder="ì•”í˜¸í™”í ì´ë¦„ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸)">
            <button class="btn btn-primary" id="searchButton">ê²€ìƒ‰</button>
        </div>
        <h4>í˜„ì¬ê°€: <span id="coinPrice" style="color:#d32f2f"></span> ì›</h4>
        <div id="coinChart" style="width:100%; height:400px;"></div>
    </div>
</div>

<script>
    $(document).ready(function () {
        let currentCoinCode = "KRW-BTC";
        let chart = null;
        let candleSeries = null;

        function updatePrice(coinCode) {
            $.get("/coin/price", { coinCode: coinCode }, function (price) {
                $("#coinPrice").text(Number(price).toLocaleString());
            }).fail(function (xhr, status, error) {
                console.error("âŒ í˜„ì¬ê°€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                $("#coinPrice").text("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            });
        }

        function loadChartData(coinCode) {
            $.get("/coin/candle", { coinCode: coinCode }, function (data) {
                console.log(`ğŸ“¦ [${coinCode}] ìˆ˜ì‹ ëœ data:`, data);

                const chartData = data
                    .map((item, i) => {
                        const time = Number(item.time);
                        const open = Number(item.open);
                        const high = Number(item.high);
                        const low = Number(item.low);
                        const close = Number(item.close);

                        if (!Number.isFinite(time) || !Number.isFinite(open) || !Number.isFinite(high) || !Number.isFinite(low) || !Number.isFinite(close)) {
                            console.warn(`âŒ [${coinCode}] [${i}] í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ë˜ëŠ” ìˆ«ì ì•„ë‹˜/ë¬´í•œëŒ€ â†’ ì œì™¸`, item);
                            return null;
                        }
                        return { time, open, high, low, close };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.time - b.time);

                console.log(`âœ… [${coinCode}] ìµœì¢… ë³€í™˜ ë° ì •ë ¬ëœ chartData:`, chartData);

                if (chartData.length > 0) {
                    if (candleSeries) {
                        candleSeries.setData(chartData);
                        chart.timeScale().fitContent();
                    }
                } else {
                    console.error(`âš ï¸ [${coinCode}] ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    if (candleSeries) {
                        candleSeries.setData([]);
                        chart.timeScale().reset();
                    }
                }
                currentCoinCode = coinCode;
                updatePrice(currentCoinCode);
            }).fail(function (xhr, status, error) {
                console.error(`âŒ [${coinCode}] ìº”ë“¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:`, error);
                if (candleSeries) {
                    candleSeries.setData([]);
                    chart.timeScale().reset();
                    $("#coinPrice").text("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                }
            });
        }

        function initializeChart(coinCode) {
            chart = LightweightCharts.createChart(document.getElementById("coinChart"), {
                width: document.getElementById("coinChart").offsetWidth,
                height: 400,
                layout: { background: { color: '#ffffff' }, textColor: '#000000' },
                grid: {
                    vertLines: { color: '#f0f3fa' },
                    horzLines: { color: '#f0f3fa' }
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: { timeVisible: true, secondsVisible: false }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });

            loadChartData(coinCode);
        }

        initializeChart(currentCoinCode);

        $("#searchInput").autocomplete({
            source: function (request, response) {
                $.get("/coin/api/crypto/search", { query: request.term }, function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.name + " (" + item.code + ")",
                            value: item.name,
                            code: item.code
                        };
                    }));
                });
            },
            select: function (event, ui) {
                $("#searchInput").val(ui.item.value);
                loadChartData(ui.item.code);
                return false;
            }
        });

        $("#searchButton").on("click", function () {
            const searchText = $("#searchInput").val().trim();
            $.get("/coin/api/crypto/search", { query: searchText }, function (data) {
                if (data.length > 0) {
                    loadChartData(data[0].code); // ì²« ë²ˆì§¸ ê²°ê³¼ ì‚¬ìš© (ì •í™•ë„ ë†’ì´ê¸° ìœ„í•´ ì¶”ê°€ ë¡œì§ í•„ìš”í•  ìˆ˜ ìˆìŒ)
                } else {
                    alert("í•´ë‹¹í•˜ëŠ” ì•”í˜¸í™”íë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        });

        window.addEventListener("resize", () => {
            if (chart) {
                chart.applyOptions({ width: document.getElementById("coinChart").offsetWidth });
            }
        });
    });
</script>
</body>
</html>