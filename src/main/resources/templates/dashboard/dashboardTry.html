<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TradeMon | ìì‚° ìš”ì•½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <style>
    body {
      background-color: #f5f7fa;
      padding: 40px 20px;
      font-family: 'Segoe UI', sans-serif;
    }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 20px;
      background: white;
    }

    .text-danger { color: #d9534f !important; }
    .text-primary { color: #0275d8 !important; }

    #resetBtn {
      margin-top: 30px;
    }

    .chart-container {
      margin-top: 60px;
    }

    #assetChart, #tradePie {
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-4 text-center">ğŸ“Š ìì‚° ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h2>

  <div class="row g-4">
    <div class="col-md-6">
      <div class="card text-center mb-3">
        <h6>ì´ ìì‚°</h6>
        <h4 id="totalAsset">â‚©0</h4>
      </div>
      <div class="card text-center mb-3">
        <h6>ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡</h6>
        <h4 id="availableCash">â‚©0</h4>
      </div>
      <div class="card text-center mb-3">
        <h6>ì´ í‰ê°€ê¸ˆì•¡</h6>
        <h4 id="totalEval">â‚©0</h4>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card text-center mb-3">
        <h6>ë¯¸ì‹¤í˜„ ì†ìµ</h6>
        <h4 id="profit">â‚©0</h4>
      </div>
      <div class="card text-center mb-3">
        <h6>ì‹¤í˜„ ì†ìµ</h6>
        <h4 id="realizedProfit">â‚©0</h4>
      </div>
      <div class="card text-center mb-3">
        <h6>í‰ê°€ìˆ˜ìµë¥ </h6>
        <h4 id="rate">0%</h4>
      </div>
    </div>
  </div>

<!--  <div class="row g-4 mt-3">-->
<!--    <div class="col-md-4 offset-md-4">-->
<!--      <div class="card text-center">-->
<!--        <h6>ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡</h6>-->
<!--        <p id="orderAvailable">â‚©0</p>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

  <div class="text-center">
    <button id="resetBtn" class="btn btn-outline-danger btn-lg">
      ğŸ—‘ï¸ ìì‚° ì´ˆê¸°í™” (ëª¨ì˜íˆ¬ì ë¦¬ì…‹)
    </button>
  </div>

  <!-- ğŸ“Š ì°¨íŠ¸ ì„¹ì…˜ -->
  <div class="chart-container">
    <h4 class="text-center mt-5">ğŸ“ˆ ì¢…ëª©ë³„ ìˆ˜ìµ ë¶„ì„</h4>
    <div id="assetChart"></div>

    <h4 class="text-center mt-5">ğŸ“Š ë³´ìœ  ë¹„ì¤‘</h4>
    <div id="tradePie"></div>
  </div>
</div>

<script>
  $(document).ready(function () {
    loadSummary();
    drawProfitBarChart();
    drawTradePie();

    $("#resetBtn").click(function () {
      if (!confirm("ì •ë§ ìì‚°ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê±°ë˜ ê¸°ë¡ì´ ì‚­ì œë˜ê³  5,000ë§Œ ì›ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.")) return;

      $.post("/api/trade/reset", function (res) {
        if (res.status === "success") {
          alert("ì´ˆê¸°í™” ì™„ë£Œ! ë‹¤ì‹œ 5ì²œë§Œ ì›ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
          location.reload();
        } else {
          alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + res.message);
        }
      }).fail(function () {
        alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      });
    });

    function loadSummary() {
      $.get("/api/trade/summary", function (res) {
        if (res.status === "success") {
          const s = res.summary;
          $("#totalAsset").text(formatWon(s.totalAsset));
          $("#availableCash").text(formatWon(s.availableCash));
          $("#totalEval").text(formatWon(s.totalEval));
          $("#profit").text(formatWon(s.unrealizedProfit));
          $("#realizedProfit").text(formatWon(s.realizedProfit || 0));
          $("#rate").text(s.rate + "%");
          $("#orderAvailable").text(formatWon(s.availableCash));

          const profitVal = parseFloat(s.unrealizedProfit);
          const rateVal = parseFloat(s.rate);

          $("#profit").removeClass("text-danger text-primary")
                  .addClass(profitVal >= 0 ? "text-danger" : "text-primary");

          $("#rate").removeClass("text-danger text-primary")
                  .addClass(rateVal >= 0 ? "text-danger" : "text-primary");
        } else {
          alert(res.message || "ìš”ì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
        }
      }).fail(function () {
        alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ìì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      });
    }

    function drawProfitBarChart() {
      const chart = echarts.init(document.getElementById('assetChart'));

      $.get("/api/trade/profit-ratio", function (res) {
        if (res.status === "success") {
          const data = res.data;
          const categories = data.map(item => item.name);
          const values = data.map(item => item.value);

          chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            title: {
              text: 'ì¢…ëª©ë³„ ìˆ˜ìµë¥  ë¶„ì„',
              left: 'center',
              textStyle: { color: '#2f88ff', fontSize: 16 }
            },
            grid: { top: 60, bottom: 20, left: 20, right: 20, containLabel: true },
            xAxis: {
              type: 'value',
              position: 'top',
              splitLine: { lineStyle: { type: 'dashed', color: '#c0dfff' } },
              axisLine: { lineStyle: { color: '#c0dfff' } }
            },
            yAxis: {
              type: 'category',
              data: categories,
              axisTick: { show: false },
              axisLine: { show: false },
              axisLabel: { fontWeight: 'bold' }
            },
            series: [{
              name: 'ìˆ˜ìµë¥ ',
              type: 'bar',
              barWidth: 14,
              label: {
                show: true,
                position: 'insideRight',
                formatter: '{b}',
                fontWeight: 'bold'
              },
              itemStyle: {
                borderRadius: 4,
                color: function (params) {
                  const v = params.value;
                  return v >= 0 ? new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                    { offset: 0, color: '#ff4d4d' },
                    { offset: 1, color: '#ffd3d3' }
                  ]) : new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                    { offset: 0, color: '#8bcafe' },
                    { offset: 1, color: '#2f88ff'}
                  ]);
                }
              },
              data: values
            }]
          });
        } else {
          chart.setOption({ title: { text: 'ë°ì´í„° ì—†ìŒ' } });
        }
      });
    }

    function drawTradePie() {
      const pie = echarts.init(document.getElementById('tradePie'));

      $.get("/api/trade/holding-ratio", function (res) {
        if (res.status === "success") {
          pie.setOption({
            tooltip: { trigger: 'item' },
            legend: { top: '5%', left: 'center' },
            graphic: {
              elements: [{
                type: 'text', left: 'center', top: 'center',
                style: { text: '', textAlign: 'center', fontSize: 28, fontWeight: 'bold', fill: '#333' }
              }]
            },
            series: [{
              name: 'ë³´ìœ  ê¸ˆì•¡',
              type: 'pie',
              radius: ['40%', '70%'],
              minAngle: 5, // ğŸ‘ˆ ì¶”ê°€
              avoidLabelOverlap: false,
              itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
              },
              label: { show: false },
              labelLine: { show: false },
              data: res.holdings
            }]

          });

          pie.on('mouseover', function (params) {
            if (params.seriesType === 'pie') {
              pie.setOption({
                graphic: {
                  elements: [{
                    type: 'text',
                    left: 'center', top: 'center',
                    style: {
                      text: params.name,
                      textAlign: 'center',
                      fontSize: 28,
                      fontWeight: 'bold',
                      fill: '#333'
                    }
                  }]
                }
              });
            }
          });

          pie.on('mouseout', function () {
            pie.setOption({
              graphic: {
                elements: [{
                  type: 'text',
                  left: 'center', top: 'center',
                  style: {
                    text: '',
                    textAlign: 'center',
                    fontSize: 28,
                    fontWeight: 'bold',
                    fill: '#333'
                  }
                }]
              }
            });
          });

        } else {
          pie.setOption({ title: { text: "ë°ì´í„° ì—†ìŒ" } });
        }
      });
    }

    function formatWon(value) {
      if (!value) return "â‚©0";
      return "â‚©" + Number(value).toLocaleString();
    }
  });
</script>

</body>
</html>
